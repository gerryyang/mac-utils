---
layout: post
title:  "Game in Action"
date:   2022-10-19 08:00:00 +0800
categories: Game
---

* Do not remove this line (it will not be displayed)
{:toc}

# 专业词汇

| 名词 | 含义
| -- | --
| 3C | Control, Camera, Character, 操作, 镜头, 角色
| NPC | Non-Player-Controlled Character, 非玩家控制角色
| MMO | Massively Multiplayer Online, 大型多人在线游戏
| AOI | Area Of Interest, 游戏玩家视野




# 视野管理 (AOI - Area Of Interest)

## 背景

在大型多人在线游戏 MMO（Massively Multiplayer Online）中，多个玩家在同一场景，此时玩家需要能看到其附近的玩家，同时不需要看到与其距离远的玩家。这就是视野管理需要做的事情：为每个玩家维护一个视野列表，管理每个玩家可见视野内的其他玩家。

MMO 游戏中，视野对服务器造成的压力主要来源于两点：

1. 玩家频繁移动造成视野列表的频繁更新的压力。
2. 广播视野列表的带宽压力。

因为视野列表中的玩家频繁变化，有的玩家离开当前玩家的视野，有的玩家新进入当前玩家的视野，因此当前玩家的视野列表需要进行频繁的增、删、查操作，因此增、删、查操作的时间复杂度要尽可能的低，从而缓解视野列表频繁更新的压力。如果当前视野列表中有100个玩家，每个玩家都移动了一段距离，为了让其他玩家看到自己的移动，每个玩家都需要被通知其他99个玩家的移动，这就需要广播100*99个数据包，随着地图中玩家数目增加，造成广播量急剧增加，对带宽造成极大压力，因此玩家的视野列表需要有规模限制，从而缓解带宽压力。

## 视野管理算法

* 九宫格

游戏中地图用来承载阻挡、静态建筑、NPC等。玩家在地图上移动，其可见的其他玩家即发生变化，如果玩家的每次移动，都更新视野列表，时间成本太高，因此只有当玩家离开某个区域时，才更新视野列表，而在这个区域内的移动，并不更新视野列表。为了划分这个区域，引入九宫格概念，如图1所示，九个格子的总面积大于一个手机屏幕，小于两个手机屏幕。大于一个手机屏幕的原因是，可以预先计算当前屏幕外的一些玩家，但又没有必要预先计算太多的屏幕外玩家，因此小于两个手机屏幕，玩家可见的范围为以玩家为中心周围九个格子内的其他玩家。

* 十字链表

把地图坐标轴中的 X 和 Y 轴看成是2个链表，将玩家的 X 坐标按照从小到大插入 X 链表，将玩家的 Y 坐标按照从小到大插入 Y 链表，查询时根据玩家的坐标分别从2个链表中取出范围内的所有玩家，对两个玩家列表做交集，即为需要发送消息的玩家列表。

以玩家A(10, 3)，玩家B(4, 18)，玩家C(17, 24) 为例，则 X 链表为：B(4) - A(10) - C(17)，Y 链表为：A(3) - B(18) - C(24)，假设目标玩家D的坐标为(16, 9)，通知范围为7：根据D坐标分别查找 X 链表和 Y 链表，然后根据对应坐标向前向后查找范围在7之内的玩家( X 链表中查找到的玩家为AC，Y 链表中查找到的玩家 A )，然后对两个玩家集合取交集(结果为玩家 A )，然后对交集中的所有的玩家发送消息。


* [最快速的视野管理算法](https://cloud.tencent.com/developer/article/1006111)文章，提出一种利用无序数组、双向链表、位标记进行视野管理的算法，可以将每次增、删、查视野列表的复杂度降为O(1)


* 云风的[AOI 服务器的实现](https://blog.codingnow.com/2008/11/aoi_server.html)，[把 AOI 的部分独立出来](https://blog.codingnow.com/2008/07/aoi.html)和[AOI 的优化](https://blog.codingnow.com/2009/09/aoi_watchtower.html)




Refer:

* [深入探索AOI算法](https://zhuanlan.zhihu.com/p/201588990)











